# PROBLEMA CR√çTICO DESCOBERTO E RESOLVIDO - V6.1

## üî¥ PROBLEMA: Lock Travado Bloqueando Sistema

### O que aconteceu:

Voc√™ enviou 5 mensagens r√°pidas (17:10:33 at√© 17:11:40) e **n√£o recebeu nenhuma resposta**.

**Diagn√≥stico:**
```sql
SELECT batch_lock_id, batch_lock_until 
FROM prospecting_sessions 
WHERE id = 'ac31c17f-e418-4d01-bebd-048c2e39bd1d';

-- Resultado:
batch_lock_id: e76cbb09-79c5-4b1e-b601-140388d4410e
batch_lock_until: 2025-12-11 17:12:41  <-- Lock travado por 2 minutos!
```

**Timeline:**
- 17:10:15 - √öltima resposta agent (funcionou)
- 17:10:33 - Cliente envia "A bel√™"
- 17:10:35 - Cliente envia "Mano"
- 17:10:44 - Cliente envia "Q se me diz"
- 17:11:03 - Cliente envia "Cara"
- 17:11:40 - Cliente envia "Show beleza"
- **NENHUMA RESPOSTA AGENT** ‚ùå

**Por qu√™?**
1. Um webhook adquiriu o lock em 17:10:41
2. Algo deu erro durante o processamento (provavelmente chamada ao GPT)
3. O catch **N√ÉO CONSEGUIU** liberar o lock
4. Todos os outros 4 webhooks ficaram bloqueados at√© 17:12:41

## üêõ ROOT CAUSE: `supabaseAdmin` N√£o Dispon√≠vel no Catch

### C√≥digo Problem√°tico (V6):

```typescript
serve(async (req) => {
  try {
    let webhookId: string | undefined;
    let session: { id: string } | null | undefined;
    
    const supabaseAdmin = createClient(...);  // ‚Üê DENTRO do try
    
    // ... c√≥digo ...
    
  } catch (error) {
    // ‚ùå supabaseAdmin N√ÉO EXISTE AQUI!
    if (webhookId && session?.id) {
      await supabaseAdmin.rpc('release_batch_lock', { ... });  // ‚Üê ERRO!
    }
  }
});
```

**Problema:**
- `supabaseAdmin` √© uma `const` criada **dentro** do try
- JavaScript n√£o permite acessar `const` de dentro do try no catch
- Catch n√£o conseguia liberar o lock
- Lock ficava travado at√© expirar (2 minutos)

## ‚úÖ SOLU√á√ÉO V6.1: Declarar Vari√°veis Fora do Try

```typescript
serve(async (req) => {
  // ‚úÖ Declarar FORA do try
  let webhookId: string | undefined;
  let session: { id: string } | null | undefined;
  let supabaseAdmin: any;

  try {
    supabaseAdmin = createClient(...);  // ‚Üê Atribuir dentro do try
    
    // ... c√≥digo ...
    
  } catch (error) {
    // ‚úÖ AGORA supabaseAdmin est√° dispon√≠vel!
    if (webhookId && session?.id && supabaseAdmin) {
      await supabaseAdmin.rpc('release_batch_lock', { ... });
    }
  }
});
```

**Benef√≠cios:**
- Catch tem acesso ao `supabaseAdmin`
- Lock √© liberado mesmo com erro
- Sistema n√£o trava mais
- Pr√≥ximos webhooks podem processar

## üîß A√á√ÉO TOMADA

1. ‚úÖ Identificado lock travado na sess√£o
2. ‚úÖ Liberado lock manualmente via SQL
3. ‚úÖ Corrigido c√≥digo (declarar vari√°veis fora do try)
4. ‚úÖ Deploy vers√£o 64 (V6.1)
5. ‚úÖ Commit + push para GitHub

## üìä COMPARA√á√ÉO

| Aspecto | V6 (BUGADO) | V6.1 (CORRIGIDO) |
|---------|-------------|------------------|
| supabaseAdmin no catch | ‚ùå N√£o dispon√≠vel | ‚úÖ Dispon√≠vel |
| Lock liberado com erro | ‚ùå N√£o | ‚úÖ Sim |
| Sistema trava | ‚ùå Sim (2 min) | ‚úÖ N√£o |
| Webhooks bloqueados | ‚ùå Todos | ‚úÖ Nenhum |

## üß™ TESTE NOVAMENTE

**AGORA voc√™ pode testar novamente:**

1. Envie 5-6 mensagens r√°pidas
2. **Resultado esperado:**
   - ‚úÖ 1 resposta consolidada da IA
   - ‚úÖ Nenhuma duplicata
   - ‚úÖ Se der erro, lock √© liberado imediatamente

**Verificar se funcionou:**

```sql
-- Conferir que lock N√ÉO est√° travado
SELECT batch_lock_id, batch_lock_until 
FROM prospecting_sessions 
WHERE id = 'ac31c17f-e418-4d01-bebd-048c2e39bd1d';

-- Deve retornar NULL, NULL (ou j√° expirado)
```

## üéØ PR√ìXIMAS MELHORIAS (FUTURAS)

1. **Timeout autom√°tico do lock** - Se webhook demorar muito, liberar automaticamente
2. **Health check** - Script que monitora locks travados e libera
3. **Alertas** - Notificar quando lock ficar travado > 30s
4. **Retry autom√°tico** - Se falhar, outro webhook assume automaticamente

---

**Deploy:** Vers√£o 64 (V6.1)  
**Status:** ACTIVE  
**Data:** 2025-12-11 17:15  
**Pronto para:** TESTES REAIS
